import re
from argparse import ArgumentParser

import sys


def decrypt_str(encrypted_str, key=None):
    decrypt_key = "XuN3FPQE02SeCLGkdNk8IlZHg2lFNZqD07QWLocaU4evvtUGEIP" if not key else key
    plain_str = ''
    if len(encrypted_str) == 0:
        return plain_str

    key_counter = 0
    aux_int = int(encrypted_str[:2], 16)
    for i in range(2, len(encrypted_str), 2):
        enc_int = int(encrypted_str[i:][:2], 16)
        dec_int = enc_int ^ ord(decrypt_key[key_counter])
        dec_int = 255 + dec_int - aux_int if dec_int <= aux_int else dec_int - aux_int
        plain_str += chr(dec_int)
        key_counter += 1 if key_counter < len(decrypt_key) else 1
        aux_int = enc_int
    return plain_str


if __name__ == "__main__":

    parser = ArgumentParser(description='AutoIt Malware BR Decrypter',
                            epilog='Example: \n ./au3_br_decrypt -f "decompiled.au3"')
    parser.add_argument('-f', '--file', help='File path', type=str, required=False, default=False)
    parser.add_argument('-k', '--key', help='Decrypt Key', type=str, required=False, default=False)

    args = parser.parse_args()
    if not args.file:
        sys.exit(0)

    with open(args.file, "r") as f:
        ft = f.read()
        for item in re.findall("[A-Fa-f0-9]+", ft):
            if len(item) < 5:
                continue
            ds = decrypt_str(item.replace('\"', ''), args.key)
            if ds.isprintable() and len(ds) > 3:
                print(ds)
